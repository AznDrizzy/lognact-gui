{% extends 'template.html' %}
{% block title %} {{_('task list')}} {% endblock %}
{% block work %}
{% set (tasks_list) = results %}
{% set icon_mapping = {
                      'running': 'glyphicon glyphicon-refresh',
                      'ok': 'glyphicon glyphicon-ok',
                      'ko': 'glyphicon glyphicon-exclamation-sign',
                      'killed': 'glyphicon glyphicon-ban-circle',
                      'disappeared': 'glyphicon glyphicon-question-sign'
                      } %}

<section class = "page_tasks_list">

<div class= "up">

<div class="tasks_list">
  <div class="panel panel-info set_overflow">
    <div class="panel-heading">{{_('Tasks list')}}</div>
      <div class = 'search'>
        <form method="POST" action ="{{ url_for('connection') }}">
          <table>
            <tr>
              <td><input name="nodename" id="nodename" required></td>
              <td><input class='btn btn-default' type="submit" value="{{ _('search by name') }}"><td>
            <tr>
          </table>
        </form>
      </div>
      <div class="table_configured">
        <table class="table table-hover">
          <tr>
            <th class="col1">{{_('Task id')}}</th>
            <th>{{_('PID')}}</th>
            <th>{{_('Start by')}}</th>
            <th>{{_('Command')}}</th>
            <th>{{_('Status')}}</th>
            <th>{{_('Start')}}</th>
            <th>{{_('End')}}</th>
            <th>{{_('Kill task')}}</th>
          </tr>
          {% for task_id, task_data in tasks_list.items() %}
          <tr>
            <td>{{task_id}}</td>
            <td>{{task_pid}}</td>
            <td>{{task_data.username}}</td>
            <td>{{task_data.command}}</td>
            <td><span  class="{{ icon_mapping[task_data.status] }}"></td>
            <td>{{task_data.start_date}}</td>
            <td>{{task_data.end_date}}</td>
            {% if task_data.status == 'running' %}
            <td><a type="button" class="btn btn-danger" href="/task_list/kill_task/{{ task_id }}">{{_('kill')}}</a></td>
            {% else %}
            <td></td>
            {% endif %}
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>
  </div>
</div>


<div class="down">

  <div class="tasks_log">
    <div class="panel panel-warning set_overflow">
      <div class="panel-heading">{{_('Output')}}</div>
          <div class="table_and_body">
            <table class="table">
              <tr>
                <pre id="contenu_tache_en_cours"></pre>
              </tr>
            </table>
          </div>
        </div>
      </div>
  </div>

</div>
<script>

function traite(request, response){
  var tache = JSON.parse(response);
  var id = 1;
  if(tache.execution != null){
    var txt = tache.execution;
    txt = txt.replace(/\\n/g, "\n")
    txt = txt.replace(/\\t/g, "\t")
    var ansi_up = new AnsiUp;
    var html = ansi_up.ansi_to_html(txt);
    var cdiv = document.getElementById("contenu_tache_en_cours");
    cdiv.innerHTML = html;
  }
}

</script>

</section>


{% endblock %}
